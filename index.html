<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Terminal Hub</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            background-color: #000;
            overflow: hidden;
        }

        #terminal-container {
            height: 100%;
            width: 100%;
        }
    </style>
    <!-- xterm.js CDN -->
    <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
</head>

<body>
    <div id="terminal-container"></div>
    <script>
        // Use a high-quality monospace font stack
        const theme = {
            background: '#000000',
            foreground: '#ffffff',
            cursor: '#ffffff',
            selection: 'rgba(255, 255, 255, 0.3)',
            black: '#000000',
            red: '#e06c75',
            green: '#98c379',
            yellow: '#d19a66',
            blue: '#61afef',
            magenta: '#c678dd',
            cyan: '#56b6c2',
            white: '#abb2bf',
            brightBlack: '#5c6370',
            brightRed: '#e06c75',
            brightGreen: '#98c379',
            brightYellow: '#d19a66',
            brightBlue: '#61afef',
            brightMagenta: '#c678dd',
            brightCyan: '#56b6c2',
            brightWhite: '#ffffff'
        };

        // Terminal setup
        const term = new Terminal({
            cursorBlink: true,
            macOptionIsMeta: true,
            scrollback: 1000,
            fontSize: 14,
            fontFamily: 'monospace',
            theme: theme,
            allowProposedApi: true
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        term.open(document.getElementById('terminal-container'));

        // Use a small delay for the initial fit to ensure the container is fully rendered
        setTimeout(() => {
            fitAddon.fit();
            sendResize();
        }, 100);

        // WebSocket setup
        const protocol = (location.protocol === 'https:') ? 'wss://' : 'ws://';
        const wsUrl = protocol + location.host + '/ws';
        const ws = new WebSocket(wsUrl);
        ws.binaryType = 'arraybuffer';

        ws.onopen = () => {
            term.write('\r\n\x1b[32m[SYSTEM] Connected to Terminal Hub\x1b[0m\r\n');
            sendResize();
        };

        ws.onmessage = (event) => {
            if (event.data instanceof ArrayBuffer) {
                term.write(new Uint8Array(event.data));
            } else {
                term.write(event.data);
            }
        };

        ws.onclose = () => {
            term.write('\r\n\x1b[31m[SYSTEM] Connection Closed\x1b[0m\r\n');
        };

        ws.onerror = (err) => {
            console.error('WebSocket Error:', err);
            term.write('\r\n\x1b[31m[SYSTEM] WebSocket Error\x1b[0m\r\n');
        };

        // Input handling
        term.onData(data => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'input',
                    data: data
                }));
            }
        });

        // Resize handling
        function sendResize() {
            if (ws.readyState === WebSocket.OPEN) {
                const dims = fitAddon.proposeDimensions();
                if (dims) {
                    term.resize(dims.cols, dims.rows);
                    ws.send(JSON.stringify({
                        type: 'resize',
                        cols: dims.cols,
                        rows: dims.rows
                    }));
                }
            }
        }

        let resizeTimeout;
        window.addEventListener('resize', () => {
            // Debounce resize events
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                fitAddon.fit();
                sendResize();
            }, 100);
        });

    </script>
</body>

</html>